# 動画背景除去ツール - CI/CD ビルドワークフロー
#
# トリガー:
#   - mainブランチへのプッシュ → ビルド＆GitHub Releasesに自動公開
#   - feature/*ブランチへのプッシュ → デバッグビルド（Artifactsのみ）
#   - タグ作成（v*） → GitHub Releasesに公開
#
# ビルド対象:
#   - Windows GPU版 (CUDA)
#   - Windows CPU版
#   - macOS版 (Apple Silicon)

name: Build

on:
  push:
    branches:
      - main
      - 'feature/*'
    tags:
      - 'v*'
  workflow_dispatch:  # 手動実行も可能

jobs:
  # =============================================================================
  # Windows GPU版ビルド
  # =============================================================================
  build-windows-gpu:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pip\Cache
          key: ${{ runner.os }}-pip-gpu-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-gpu-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install torch torchvision --index-url https://download.pytorch.org/whl/cu118
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Download ffmpeg
        run: |
          mkdir ffmpeg
          Invoke-WebRequest -Uri "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip" -OutFile "ffmpeg.zip"
          Expand-Archive -Path "ffmpeg.zip" -DestinationPath "ffmpeg_temp"
          Copy-Item "ffmpeg_temp\ffmpeg-master-latest-win64-gpl\bin\ffmpeg.exe" "ffmpeg\ffmpeg.exe"
          Remove-Item -Recurse -Force "ffmpeg_temp", "ffmpeg.zip"

      - name: Create entry point script
        run: |
          @"
          # -*- coding: utf-8 -*-
          """PyInstaller用エントリーポイント"""
          import sys
          from pathlib import Path

          # srcディレクトリをパスに追加
          sys.path.insert(0, str(Path(__file__).parent / "src"))

          from main import main

          if __name__ == "__main__":
              main()
          "@ | Out-File -FilePath run_app.py -Encoding utf8

      - name: Build with PyInstaller
        run: |
          pyinstaller `
            --name "BackgroundRemover_GPU" `
            --onedir `
            --windowed `
            --icon "assets/icon.ico" `
            --add-data "models;models" `
            --add-data "src;src" `
            --add-data "assets;assets" `
            --add-data "ffmpeg;ffmpeg" `
            --hidden-import "tkinter" `
            --hidden-import "tkinter.ttk" `
            --hidden-import "tkinter.filedialog" `
            --hidden-import "tkinter.messagebox" `
            --hidden-import "torch" `
            --hidden-import "torchvision" `
            --hidden-import "cv2" `
            --hidden-import "PIL" `
            --hidden-import "numpy" `
            --hidden-import "tkinterdnd2" `
            --hidden-import "customtkinter" `
            --collect-all "torch" `
            --collect-all "torchvision" `
            --collect-all "tkinterdnd2" `
            --collect-all "customtkinter" `
            run_app.py

      - name: Create ZIP archive
        run: |
          Compress-Archive -Path "dist\BackgroundRemover_GPU" -DestinationPath "BackgroundRemover_Windows_GPU.zip"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: BackgroundRemover_Windows_GPU
          path: BackgroundRemover_Windows_GPU.zip
          retention-days: 90

  # =============================================================================
  # Windows CPU版ビルド
  # =============================================================================
  build-windows-cpu:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pip\Cache
          key: ${{ runner.os }}-pip-cpu-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-cpu-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Download ffmpeg
        run: |
          mkdir ffmpeg
          Invoke-WebRequest -Uri "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip" -OutFile "ffmpeg.zip"
          Expand-Archive -Path "ffmpeg.zip" -DestinationPath "ffmpeg_temp"
          Copy-Item "ffmpeg_temp\ffmpeg-master-latest-win64-gpl\bin\ffmpeg.exe" "ffmpeg\ffmpeg.exe"
          Remove-Item -Recurse -Force "ffmpeg_temp", "ffmpeg.zip"

      - name: Create entry point script
        run: |
          @"
          # -*- coding: utf-8 -*-
          """PyInstaller用エントリーポイント"""
          import sys
          from pathlib import Path

          # srcディレクトリをパスに追加
          sys.path.insert(0, str(Path(__file__).parent / "src"))

          from main import main

          if __name__ == "__main__":
              main()
          "@ | Out-File -FilePath run_app.py -Encoding utf8

      - name: Build with PyInstaller
        run: |
          pyinstaller `
            --name "BackgroundRemover_CPU" `
            --onedir `
            --windowed `
            --icon "assets/icon.ico" `
            --add-data "models;models" `
            --add-data "src;src" `
            --add-data "assets;assets" `
            --add-data "ffmpeg;ffmpeg" `
            --hidden-import "tkinter" `
            --hidden-import "tkinter.ttk" `
            --hidden-import "tkinter.filedialog" `
            --hidden-import "tkinter.messagebox" `
            --hidden-import "torch" `
            --hidden-import "torchvision" `
            --hidden-import "cv2" `
            --hidden-import "PIL" `
            --hidden-import "numpy" `
            --hidden-import "tkinterdnd2" `
            --hidden-import "customtkinter" `
            --collect-all "torch" `
            --collect-all "torchvision" `
            --collect-all "tkinterdnd2" `
            --collect-all "customtkinter" `
            run_app.py

      - name: Create ZIP archive
        run: |
          Compress-Archive -Path "dist\BackgroundRemover_CPU" -DestinationPath "BackgroundRemover_Windows_CPU.zip"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: BackgroundRemover_Windows_CPU
          path: BackgroundRemover_Windows_CPU.zip
          retention-days: 90

  # =============================================================================
  # macOS版ビルド (Apple Silicon)
  # =============================================================================
  build-macos:
    runs-on: macos-14  # Apple Silicon (M1) ランナー
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install torch torchvision
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Install ffmpeg
        run: brew install ffmpeg

      - name: Create entry point script
        run: |
          cat > run_app.py << 'EOF'
          # -*- coding: utf-8 -*-
          """PyInstaller用エントリーポイント"""
          import sys
          from pathlib import Path

          # srcディレクトリをパスに追加
          sys.path.insert(0, str(Path(__file__).parent / "src"))

          from main import main

          if __name__ == "__main__":
              main()
          EOF

      - name: Build with PyInstaller
        run: |
          FFMPEG_PATH=$(which ffmpeg)
          pyinstaller \
            --name "BackgroundRemover_Mac" \
            --onedir \
            --windowed \
            --icon "assets/icon.icns" \
            --add-data "models:models" \
            --add-data "src:src" \
            --add-data "assets:assets" \
            --add-binary "${FFMPEG_PATH}:ffmpeg" \
            --hidden-import "tkinter" \
            --hidden-import "tkinter.ttk" \
            --hidden-import "tkinter.filedialog" \
            --hidden-import "tkinter.messagebox" \
            --hidden-import "torch" \
            --hidden-import "torchvision" \
            --hidden-import "cv2" \
            --hidden-import "PIL" \
            --hidden-import "numpy" \
            --hidden-import "tkinterdnd2" \
            --hidden-import "customtkinter" \
            --collect-all "torch" \
            --collect-all "torchvision" \
            --collect-all "tkinterdnd2" \
            --collect-all "customtkinter" \
            --osx-bundle-identifier "com.internal.backgroundremover" \
            run_app.py

      - name: Create .app bundle
        run: |
          mkdir -p "dist/BackgroundRemover_Mac.app/Contents/MacOS"
          mkdir -p "dist/BackgroundRemover_Mac.app/Contents/Resources"
          cp -R dist/BackgroundRemover_Mac/* "dist/BackgroundRemover_Mac.app/Contents/MacOS/"
          cat > "dist/BackgroundRemover_Mac.app/Contents/Info.plist" << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleName</key>
              <string>BackgroundRemover</string>
              <key>CFBundleDisplayName</key>
              <string>動画背景除去ツール by META AI LABO</string>
              <key>CFBundleIdentifier</key>
              <string>com.internal.backgroundremover</string>
              <key>CFBundleVersion</key>
              <string>1.0.0</string>
              <key>CFBundleShortVersionString</key>
              <string>1.0.0</string>
              <key>CFBundleExecutable</key>
              <string>BackgroundRemover_Mac</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>LSMinimumSystemVersion</key>
              <string>11.0</string>
              <key>NSHighResolutionCapable</key>
              <true/>
              <key>LSArchitecturePriority</key>
              <array>
                  <string>arm64</string>
              </array>
          </dict>
          </plist>
          EOF
          rm -rf "dist/BackgroundRemover_Mac"

      - name: Create ZIP archive
        run: |
          cd dist && zip -r ../BackgroundRemover_macOS.zip BackgroundRemover_Mac.app

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: BackgroundRemover_macOS
          path: BackgroundRemover_macOS.zip
          retention-days: 90

  # =============================================================================
  # リリース作成（mainブランチまたはタグ作成時）
  # =============================================================================
  release:
    needs: [build-windows-gpu, build-windows-cpu, build-macos]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate version tag
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            # タグからバージョンを取得
            VERSION="${{ github.ref_name }}"
          else
            # 日時ベースのバージョンを生成
            VERSION="v1.0.$(date +'%Y%m%d-%H%M')"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Generated version: ${VERSION}"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          files: |
            artifacts/BackgroundRemover_Windows_GPU/BackgroundRemover_Windows_GPU.zip
            artifacts/BackgroundRemover_Windows_CPU/BackgroundRemover_Windows_CPU.zip
            artifacts/BackgroundRemover_macOS/BackgroundRemover_macOS.zip
          generate_release_notes: true
          draft: false
          prerelease: false
