# å‹•ç”»èƒŒæ™¯é™¤å»ãƒ„ãƒ¼ãƒ« - CI/CD ãƒ“ãƒ«ãƒ‰ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
#
# ãƒˆãƒªã‚¬ãƒ¼:
#   - mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ â†’ ãƒ“ãƒ«ãƒ‰ï¼†GitHub Releasesã«è‡ªå‹•å…¬é–‹
#   - feature/*ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ â†’ ãƒ‡ãƒãƒƒã‚°ãƒ“ãƒ«ãƒ‰ï¼ˆArtifactsã®ã¿ï¼‰
#   - ã‚¿ã‚°ä½œæˆï¼ˆv*ï¼‰ â†’ GitHub Releasesã«å…¬é–‹
#
# ãƒ“ãƒ«ãƒ‰å¯¾è±¡:
#   - Windows GPUç‰ˆ (CUDA)
#   - Windows CPUç‰ˆ
#   - macOSç‰ˆ (Apple Silicon)

name: Build

on:
  push:
    branches:
      - main
      - 'feature/*'
    tags:
      - 'v*'
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  # =============================================================================
  # Windows GPUç‰ˆãƒ“ãƒ«ãƒ‰
  # =============================================================================
  build-windows-gpu:
    runs-on: windows-latest
    steps:
      - name: Generate timestamp
        id: timestamp
        run: |
          $timestamp = (Get-Date).ToUniversalTime().ToString("yyyyMMdd-HHmm")
          echo "value=v$timestamp" >> $env:GITHUB_OUTPUT

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pip\Cache
          key: ${{ runner.os }}-pip-gpu-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-gpu-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install torch torchvision --index-url https://download.pytorch.org/whl/cu118
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Download ffmpeg
        run: |
          mkdir ffmpeg
          Invoke-WebRequest -Uri "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip" -OutFile "ffmpeg.zip"
          Expand-Archive -Path "ffmpeg.zip" -DestinationPath "ffmpeg_temp"
          Copy-Item "ffmpeg_temp\ffmpeg-master-latest-win64-gpl\bin\ffmpeg.exe" "ffmpeg\ffmpeg.exe"
          Remove-Item -Recurse -Force "ffmpeg_temp", "ffmpeg.zip"

      - name: Create entry point script
        run: |
          @"
          # -*- coding: utf-8 -*-
          """PyInstallerç”¨ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ"""
          import sys
          from pathlib import Path

          # srcãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ãƒ‘ã‚¹ã«è¿½åŠ 
          sys.path.insert(0, str(Path(__file__).parent / "src"))

          from main import main

          if __name__ == "__main__":
              main()
          "@ | Out-File -FilePath run_app.py -Encoding utf8

      - name: Build with PyInstaller
        run: |
          pyinstaller `
            --name "BackgroundRemover_GPU" `
            --onedir `
            --windowed `
            --icon "assets/icon.ico" `
            --add-data "models;models" `
            --add-data "src;src" `
            --add-data "assets;assets" `
            --add-data "ffmpeg;ffmpeg" `
            --hidden-import "tkinter" `
            --hidden-import "tkinter.ttk" `
            --hidden-import "tkinter.filedialog" `
            --hidden-import "tkinter.messagebox" `
            --hidden-import "torch" `
            --hidden-import "torchvision" `
            --hidden-import "cv2" `
            --hidden-import "PIL" `
            --hidden-import "numpy" `
            --hidden-import "tkinterdnd2" `
            --hidden-import "customtkinter" `
            --collect-all "torch" `
            --collect-all "torchvision" `
            --collect-all "tkinterdnd2" `
            --collect-all "customtkinter" `
            run_app.py

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: BackgroundRemover_Windows_GPU_${{ steps.timestamp.outputs.value }}
          path: dist/BackgroundRemover_GPU
          retention-days: 90

  # =============================================================================
  # Windows CPUç‰ˆãƒ“ãƒ«ãƒ‰
  # =============================================================================
  build-windows-cpu:
    runs-on: windows-latest
    steps:
      - name: Generate timestamp
        id: timestamp
        run: |
          $timestamp = (Get-Date).ToUniversalTime().ToString("yyyyMMdd-HHmm")
          echo "value=v$timestamp" >> $env:GITHUB_OUTPUT

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pip\Cache
          key: ${{ runner.os }}-pip-cpu-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-cpu-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Download ffmpeg
        run: |
          mkdir ffmpeg
          Invoke-WebRequest -Uri "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip" -OutFile "ffmpeg.zip"
          Expand-Archive -Path "ffmpeg.zip" -DestinationPath "ffmpeg_temp"
          Copy-Item "ffmpeg_temp\ffmpeg-master-latest-win64-gpl\bin\ffmpeg.exe" "ffmpeg\ffmpeg.exe"
          Remove-Item -Recurse -Force "ffmpeg_temp", "ffmpeg.zip"

      - name: Create entry point script
        run: |
          @"
          # -*- coding: utf-8 -*-
          """PyInstallerç”¨ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ"""
          import sys
          from pathlib import Path

          # srcãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ãƒ‘ã‚¹ã«è¿½åŠ 
          sys.path.insert(0, str(Path(__file__).parent / "src"))

          from main import main

          if __name__ == "__main__":
              main()
          "@ | Out-File -FilePath run_app.py -Encoding utf8

      - name: Build with PyInstaller
        run: |
          pyinstaller `
            --name "BackgroundRemover_CPU" `
            --onedir `
            --windowed `
            --icon "assets/icon.ico" `
            --add-data "models;models" `
            --add-data "src;src" `
            --add-data "assets;assets" `
            --add-data "ffmpeg;ffmpeg" `
            --hidden-import "tkinter" `
            --hidden-import "tkinter.ttk" `
            --hidden-import "tkinter.filedialog" `
            --hidden-import "tkinter.messagebox" `
            --hidden-import "torch" `
            --hidden-import "torchvision" `
            --hidden-import "cv2" `
            --hidden-import "PIL" `
            --hidden-import "numpy" `
            --hidden-import "tkinterdnd2" `
            --hidden-import "customtkinter" `
            --collect-all "torch" `
            --collect-all "torchvision" `
            --collect-all "tkinterdnd2" `
            --collect-all "customtkinter" `
            run_app.py

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: BackgroundRemover_Windows_CPU_${{ steps.timestamp.outputs.value }}
          path: dist/BackgroundRemover_CPU
          retention-days: 90

  # =============================================================================
  # macOSç‰ˆãƒ“ãƒ«ãƒ‰ (Apple Silicon)
  # =============================================================================
  build-macos:
    runs-on: macos-14  # Apple Silicon (M1) ãƒ©ãƒ³ãƒŠãƒ¼
    steps:
      - name: Generate timestamp
        id: timestamp
        run: |
          TIMESTAMP=$(date -u +"%Y%m%d-%H%M")
          echo "value=v${TIMESTAMP}" >> $GITHUB_OUTPUT

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install torch torchvision
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Install ffmpeg
        run: brew install ffmpeg

      - name: Create entry point script
        run: |
          cat > run_app.py << 'EOF'
          # -*- coding: utf-8 -*-
          """PyInstallerç”¨ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ"""
          import sys
          from pathlib import Path

          # srcãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ãƒ‘ã‚¹ã«è¿½åŠ 
          sys.path.insert(0, str(Path(__file__).parent / "src"))

          from main import main

          if __name__ == "__main__":
              main()
          EOF

      - name: Build with PyInstaller
        run: |
          FFMPEG_PATH=$(which ffmpeg)
          pyinstaller \
            --name "BackgroundRemover_Mac" \
            --onedir \
            --windowed \
            --icon "assets/icon.icns" \
            --add-data "models:models" \
            --add-data "src:src" \
            --add-data "assets:assets" \
            --add-binary "${FFMPEG_PATH}:ffmpeg" \
            --hidden-import "tkinter" \
            --hidden-import "tkinter.ttk" \
            --hidden-import "tkinter.filedialog" \
            --hidden-import "tkinter.messagebox" \
            --hidden-import "torch" \
            --hidden-import "torchvision" \
            --hidden-import "cv2" \
            --hidden-import "PIL" \
            --hidden-import "numpy" \
            --hidden-import "tkinterdnd2" \
            --hidden-import "customtkinter" \
            --collect-all "torch" \
            --collect-all "torchvision" \
            --collect-all "tkinterdnd2" \
            --collect-all "customtkinter" \
            --osx-bundle-identifier "com.internal.backgroundremover" \
            run_app.py

      - name: Create .app bundle
        run: |
          mkdir -p "dist/BackgroundRemover_Mac.app/Contents/MacOS"
          mkdir -p "dist/BackgroundRemover_Mac.app/Contents/Resources"
          cp -R dist/BackgroundRemover_Mac/* "dist/BackgroundRemover_Mac.app/Contents/MacOS/"
          cat > "dist/BackgroundRemover_Mac.app/Contents/Info.plist" << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleName</key>
              <string>BackgroundRemover</string>
              <key>CFBundleDisplayName</key>
              <string>å‹•ç”»èƒŒæ™¯é™¤å»ãƒ„ãƒ¼ãƒ« by META AI LABO</string>
              <key>CFBundleIdentifier</key>
              <string>com.internal.backgroundremover</string>
              <key>CFBundleVersion</key>
              <string>1.0.0</string>
              <key>CFBundleShortVersionString</key>
              <string>1.0.0</string>
              <key>CFBundleExecutable</key>
              <string>BackgroundRemover_Mac</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>LSMinimumSystemVersion</key>
              <string>11.0</string>
              <key>NSHighResolutionCapable</key>
              <true/>
              <key>LSArchitecturePriority</key>
              <array>
                  <string>arm64</string>
              </array>
          </dict>
          </plist>
          EOF
          rm -rf "dist/BackgroundRemover_Mac"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: BackgroundRemover_macOS_${{ steps.timestamp.outputs.value }}
          path: dist/BackgroundRemover_Mac.app
          retention-days: 90

  # =============================================================================
  # ãƒªãƒªãƒ¼ã‚¹ä½œæˆï¼ˆmainãƒ–ãƒ©ãƒ³ãƒã¾ãŸã¯ã‚¿ã‚°ä½œæˆæ™‚ï¼‰
  # =============================================================================
  release:
    needs: [build-windows-gpu, build-windows-cpu, build-macos]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate version tag
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            # ã‚¿ã‚°ã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
            VERSION="${{ github.ref_name }}"
          else
            # æ—¥æ™‚ãƒ™ãƒ¼ã‚¹ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç”Ÿæˆ
            VERSION="v1.0.$(date +'%Y%m%d-%H%M')"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Generated version: ${VERSION}"

      - name: Download CPU artifact
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: BackgroundRemover_Windows_CPU_*

      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: BackgroundRemover_macOS_*

      - name: Find GPU artifact URL
        id: gpu_artifact
        run: |
          # GPUç‰ˆArtifactã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URLï¼ˆGitHub Actionsãƒšãƒ¼ã‚¸ï¼‰ã‚’ç”Ÿæˆ
          GPU_ARTIFACT_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "url=${GPU_ARTIFACT_URL}" >> $GITHUB_OUTPUT

      - name: List downloaded artifacts
        run: |
          echo "Downloaded artifacts:"
          find artifacts -type d -o -type f | head -50

      - name: Create ZIP archives with timestamp
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Windows CPUç‰ˆã‚’zipåŒ–
          CPU_DIR=$(find artifacts -type d -name "BackgroundRemover_Windows_CPU_*" | head -1)
          if [ -n "$CPU_DIR" ]; then
            cd "$CPU_DIR"
            zip -r "../../BackgroundRemover_Windows_CPU_${VERSION}.zip" .
            cd ../..
          fi

          # macOSç‰ˆã‚’zipåŒ–
          MAC_DIR=$(find artifacts -type d -name "BackgroundRemover_macOS_*" | head -1)
          if [ -n "$MAC_DIR" ]; then
            cd "$MAC_DIR"
            zip -r "../../BackgroundRemover_macOS_${VERSION}.zip" .
            cd ../..
          fi

          echo "Created ZIP files:"
          ls -la *.zip

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          files: |
            BackgroundRemover_Windows_CPU_${{ steps.version.outputs.version }}.zip
            BackgroundRemover_macOS_${{ steps.version.outputs.version }}.zip
          body: |
            ## ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

            ### æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«
            - **Windows CPUç‰ˆ** - BackgroundRemover_Windows_CPU_${{ steps.version.outputs.version }}.zip
            - **macOSç‰ˆ** - BackgroundRemover_macOS_${{ steps.version.outputs.version }}.zip

            ### Windows GPUç‰ˆ (CUDAå¯¾å¿œ)
            GPUç‰ˆã¯2GBã‚’è¶…ãˆã‚‹ãŸã‚ã€GitHub Artifactsã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„:
            ğŸ‘‰ **[Windows GPUç‰ˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰](${{ steps.gpu_artifact.outputs.url }})**

            â€» Artifactsãƒšãƒ¼ã‚¸ã§ã€ŒBackgroundRemover_Windows_GPU_xxxã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

            ---
            _è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸãƒªãƒªãƒ¼ã‚¹ã§ã™_
          draft: false
          prerelease: false
