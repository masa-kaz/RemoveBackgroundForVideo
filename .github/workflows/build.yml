# ÂãïÁîªËÉåÊôØÈô§Âéª„ÉÑ„Éº„É´ - CI/CD „Éì„É´„Éâ„ÉØ„Éº„ÇØ„Éï„É≠„Éº
#
# „Éà„É™„Ç¨„Éº:
#   - main„Éñ„É©„É≥„ÉÅ„Å∏„ÅÆ„Éó„ÉÉ„Ç∑„É• ‚Üí „Éì„É´„ÉâÔºÜGitHub Releases„Å´Ëá™ÂãïÂÖ¨Èñã
#   - feature/*„Éñ„É©„É≥„ÉÅ„Å∏„ÅÆ„Éó„ÉÉ„Ç∑„É• ‚Üí „Éá„Éê„ÉÉ„Ç∞„Éì„É´„ÉâÔºàArtifacts„ÅÆ„ÅøÔºâ
#   - „Çø„Ç∞‰ΩúÊàêÔºàv*Ôºâ ‚Üí GitHub Releases„Å´ÂÖ¨Èñã
#
# „Éì„É´„ÉâÂØæË±°:
#   - Windows GPUÁâà (CUDA)
#   - Windows CPUÁâà
#   - macOSÁâà (Apple Silicon)

name: Build

on:
  push:
    branches:
      - main
      - 'feature/*'
    tags:
      - 'v*'
  workflow_dispatch:  # ÊâãÂãïÂÆüË°å„ÇÇÂèØËÉΩ

jobs:
  # =============================================================================
  # Windows GPUÁâà„Éì„É´„Éâ
  # =============================================================================
  build-windows-gpu:
    runs-on: windows-latest
    steps:
      - name: Generate timestamp
        id: timestamp
        run: |
          $timestamp = (Get-Date).ToUniversalTime().ToString("yyyyMMdd-HHmm")
          echo "value=v$timestamp" >> $env:GITHUB_OUTPUT

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pip\Cache
          key: ${{ runner.os }}-pip-gpu-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-gpu-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install torch torchvision --index-url https://download.pytorch.org/whl/cu118
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Download ffmpeg
        run: |
          mkdir ffmpeg
          Invoke-WebRequest -Uri "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip" -OutFile "ffmpeg.zip"
          Expand-Archive -Path "ffmpeg.zip" -DestinationPath "ffmpeg_temp"
          Copy-Item "ffmpeg_temp\ffmpeg-master-latest-win64-gpl\bin\ffmpeg.exe" "ffmpeg\ffmpeg.exe"
          Remove-Item -Recurse -Force "ffmpeg_temp", "ffmpeg.zip"

      - name: Create entry point script
        run: |
          @"
          # -*- coding: utf-8 -*-
          """PyInstallerÁî®„Ç®„É≥„Éà„É™„Éº„Éù„Ç§„É≥„Éà"""
          import sys
          from pathlib import Path

          # src„Éá„Ç£„É¨„ÇØ„Éà„É™„Çí„Éë„Çπ„Å´ËøΩÂä†
          sys.path.insert(0, str(Path(__file__).parent / "src"))

          from main import main

          if __name__ == "__main__":
              main()
          "@ | Out-File -FilePath run_app.py -Encoding utf8

      - name: Build with PyInstaller
        run: |
          pyinstaller `
            --name "BackgroundRemover_GPU" `
            --onedir `
            --windowed `
            --icon "assets/icon.ico" `
            --add-data "models;models" `
            --add-data "src;src" `
            --add-data "assets;assets" `
            --add-data "ffmpeg;ffmpeg" `
            --hidden-import "tkinter" `
            --hidden-import "tkinter.ttk" `
            --hidden-import "tkinter.filedialog" `
            --hidden-import "tkinter.messagebox" `
            --hidden-import "torch" `
            --hidden-import "torchvision" `
            --hidden-import "cv2" `
            --hidden-import "PIL" `
            --hidden-import "numpy" `
            --hidden-import "tkinterdnd2" `
            --hidden-import "customtkinter" `
            --collect-all "torch" `
            --collect-all "torchvision" `
            --collect-all "tkinterdnd2" `
            --collect-all "customtkinter" `
            run_app.py

      - name: Upload Artifact (ZIP)
        uses: actions/upload-artifact@v4
        with:
          name: BackgroundRemover_Windows_GPU_${{ steps.timestamp.outputs.value }}
          path: dist/BackgroundRemover_GPU
          retention-days: 90

      - name: Build GPU Installer with Inno Setup
        uses: Minionguyjpro/Inno-Setup-Action@v1.2.4
        with:
          path: installer/setup_gpu.iss
          options: /O"dist"

      - name: Verify GPU Installer was created
        run: |
          $installerPath = "dist/BackgroundRemover_GPU_Setup.exe"
          if (Test-Path $installerPath) {
            $size = (Get-Item $installerPath).Length
            $sizeMB = [math]::Round($size / 1MB, 2)
            Write-Host "‚úÖ GPU Installer created successfully"
            Write-Host "   Path: $installerPath"
            Write-Host "   Size: $sizeMB MB"

            # „Çµ„Ç§„Ç∫Ê§úË®ºÔºà500MB„Äú3GBÔºâ
            if ($sizeMB -lt 500) {
              Write-Host "‚ö†Ô∏è Warning: Installer size is smaller than expected ($sizeMB MB < 500 MB)"
            } elseif ($sizeMB -gt 3000) {
              Write-Host "‚ö†Ô∏è Warning: Installer size is larger than expected ($sizeMB MB > 3000 MB)"
            } else {
              Write-Host "‚úÖ Installer size is within expected range"
            }
          } else {
            Write-Host "‚ùå GPU Installer not found at $installerPath"
            exit 1
          }

      - name: Upload GPU Installer Artifact
        uses: actions/upload-artifact@v4
        with:
          name: BackgroundRemover_GPU_Setup_${{ steps.timestamp.outputs.value }}
          path: dist/BackgroundRemover_GPU_Setup.exe
          retention-days: 90

  # =============================================================================
  # Windows CPUÁâà„Éì„É´„Éâ
  # =============================================================================
  build-windows-cpu:
    runs-on: windows-latest
    steps:
      - name: Generate timestamp
        id: timestamp
        run: |
          $timestamp = (Get-Date).ToUniversalTime().ToString("yyyyMMdd-HHmm")
          echo "value=v$timestamp" >> $env:GITHUB_OUTPUT

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pip\Cache
          key: ${{ runner.os }}-pip-cpu-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-cpu-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Download ffmpeg
        run: |
          mkdir ffmpeg
          Invoke-WebRequest -Uri "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip" -OutFile "ffmpeg.zip"
          Expand-Archive -Path "ffmpeg.zip" -DestinationPath "ffmpeg_temp"
          Copy-Item "ffmpeg_temp\ffmpeg-master-latest-win64-gpl\bin\ffmpeg.exe" "ffmpeg\ffmpeg.exe"
          Remove-Item -Recurse -Force "ffmpeg_temp", "ffmpeg.zip"

      - name: Create entry point script
        run: |
          @"
          # -*- coding: utf-8 -*-
          """PyInstallerÁî®„Ç®„É≥„Éà„É™„Éº„Éù„Ç§„É≥„Éà"""
          import sys
          from pathlib import Path

          # src„Éá„Ç£„É¨„ÇØ„Éà„É™„Çí„Éë„Çπ„Å´ËøΩÂä†
          sys.path.insert(0, str(Path(__file__).parent / "src"))

          from main import main

          if __name__ == "__main__":
              main()
          "@ | Out-File -FilePath run_app.py -Encoding utf8

      - name: Build with PyInstaller
        run: |
          pyinstaller `
            --name "BackgroundRemover_CPU" `
            --onedir `
            --windowed `
            --icon "assets/icon.ico" `
            --add-data "models;models" `
            --add-data "src;src" `
            --add-data "assets;assets" `
            --add-data "ffmpeg;ffmpeg" `
            --hidden-import "tkinter" `
            --hidden-import "tkinter.ttk" `
            --hidden-import "tkinter.filedialog" `
            --hidden-import "tkinter.messagebox" `
            --hidden-import "torch" `
            --hidden-import "torchvision" `
            --hidden-import "cv2" `
            --hidden-import "PIL" `
            --hidden-import "numpy" `
            --hidden-import "tkinterdnd2" `
            --hidden-import "customtkinter" `
            --collect-all "torch" `
            --collect-all "torchvision" `
            --collect-all "tkinterdnd2" `
            --collect-all "customtkinter" `
            run_app.py

      - name: Upload Artifact (ZIP)
        uses: actions/upload-artifact@v4
        with:
          name: BackgroundRemover_Windows_CPU_${{ steps.timestamp.outputs.value }}
          path: dist/BackgroundRemover_CPU
          retention-days: 90

      - name: Build CPU Installer with Inno Setup
        uses: Minionguyjpro/Inno-Setup-Action@v1.2.4
        with:
          path: installer/setup_cpu.iss
          options: /O"dist"

      - name: Verify CPU Installer was created
        run: |
          $installerPath = "dist/BackgroundRemover_CPU_Setup.exe"
          if (Test-Path $installerPath) {
            $size = (Get-Item $installerPath).Length
            $sizeMB = [math]::Round($size / 1MB, 2)
            Write-Host "‚úÖ CPU Installer created successfully"
            Write-Host "   Path: $installerPath"
            Write-Host "   Size: $sizeMB MB"

            # „Çµ„Ç§„Ç∫Ê§úË®ºÔºà100MB„Äú1GBÔºâ
            if ($sizeMB -lt 100) {
              Write-Host "‚ö†Ô∏è Warning: Installer size is smaller than expected ($sizeMB MB < 100 MB)"
            } elseif ($sizeMB -gt 1000) {
              Write-Host "‚ö†Ô∏è Warning: Installer size is larger than expected ($sizeMB MB > 1000 MB)"
            } else {
              Write-Host "‚úÖ Installer size is within expected range"
            }
          } else {
            Write-Host "‚ùå CPU Installer not found at $installerPath"
            exit 1
          }

      - name: Upload CPU Installer Artifact
        uses: actions/upload-artifact@v4
        with:
          name: BackgroundRemover_CPU_Setup_${{ steps.timestamp.outputs.value }}
          path: dist/BackgroundRemover_CPU_Setup.exe
          retention-days: 90

  # =============================================================================
  # macOSÁâà„Éì„É´„Éâ (Apple Silicon)
  # =============================================================================
  build-macos:
    runs-on: macos-14  # Apple Silicon (M1) „É©„É≥„Éä„Éº
    steps:
      - name: Generate timestamp
        id: timestamp
        run: |
          TIMESTAMP=$(date -u +"%Y%m%d-%H%M")
          echo "value=v${TIMESTAMP}" >> $GITHUB_OUTPUT

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install torch torchvision
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Install ffmpeg
        run: brew install ffmpeg

      - name: Create entry point script
        run: |
          cat > run_app.py << 'EOF'
          # -*- coding: utf-8 -*-
          """PyInstallerÁî®„Ç®„É≥„Éà„É™„Éº„Éù„Ç§„É≥„Éà"""
          import sys
          from pathlib import Path

          # src„Éá„Ç£„É¨„ÇØ„Éà„É™„Çí„Éë„Çπ„Å´ËøΩÂä†
          sys.path.insert(0, str(Path(__file__).parent / "src"))

          from main import main

          if __name__ == "__main__":
              main()
          EOF

      - name: Build with PyInstaller
        run: |
          FFMPEG_PATH=$(which ffmpeg)
          pyinstaller \
            --name "BackgroundRemover_Mac" \
            --onedir \
            --windowed \
            --icon "assets/icon.icns" \
            --add-data "models:models" \
            --add-data "src:src" \
            --add-data "assets:assets" \
            --add-binary "${FFMPEG_PATH}:ffmpeg" \
            --hidden-import "tkinter" \
            --hidden-import "tkinter.ttk" \
            --hidden-import "tkinter.filedialog" \
            --hidden-import "tkinter.messagebox" \
            --hidden-import "torch" \
            --hidden-import "torchvision" \
            --hidden-import "cv2" \
            --hidden-import "PIL" \
            --hidden-import "numpy" \
            --hidden-import "tkinterdnd2" \
            --hidden-import "customtkinter" \
            --collect-all "torch" \
            --collect-all "torchvision" \
            --collect-all "tkinterdnd2" \
            --collect-all "customtkinter" \
            --osx-bundle-identifier "com.internal.backgroundremover" \
            run_app.py

      - name: Create .app bundle
        run: |
          mkdir -p "dist/BackgroundRemover_Mac.app/Contents/MacOS"
          mkdir -p "dist/BackgroundRemover_Mac.app/Contents/Resources"
          cp -R dist/BackgroundRemover_Mac/* "dist/BackgroundRemover_Mac.app/Contents/MacOS/"
          cat > "dist/BackgroundRemover_Mac.app/Contents/Info.plist" << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleName</key>
              <string>BackgroundRemover</string>
              <key>CFBundleDisplayName</key>
              <string>ÂãïÁîªËÉåÊôØÈô§Âéª„ÉÑ„Éº„É´ by META AI LABO</string>
              <key>CFBundleIdentifier</key>
              <string>com.internal.backgroundremover</string>
              <key>CFBundleVersion</key>
              <string>1.0.0</string>
              <key>CFBundleShortVersionString</key>
              <string>1.0.0</string>
              <key>CFBundleExecutable</key>
              <string>BackgroundRemover_Mac</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>LSMinimumSystemVersion</key>
              <string>11.0</string>
              <key>NSHighResolutionCapable</key>
              <true/>
              <key>LSArchitecturePriority</key>
              <array>
                  <string>arm64</string>
              </array>
          </dict>
          </plist>
          EOF
          rm -rf "dist/BackgroundRemover_Mac"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: BackgroundRemover_macOS_${{ steps.timestamp.outputs.value }}
          path: dist/BackgroundRemover_Mac.app
          retention-days: 90

  # =============================================================================
  # „É™„É™„Éº„Çπ‰ΩúÊàêÔºàmain„Éñ„É©„É≥„ÉÅ„Åæ„Åü„ÅØ„Çø„Ç∞‰ΩúÊàêÊôÇÔºâ
  # =============================================================================
  release:
    needs: [build-windows-gpu, build-windows-cpu, build-macos]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate version tag
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            # „Çø„Ç∞„Åã„Çâ„Éê„Éº„Ç∏„Éß„É≥„ÇíÂèñÂæó
            VERSION="${{ github.ref_name }}"
          else
            # Êó•ÊôÇ„Éô„Éº„Çπ„ÅÆ„Éê„Éº„Ç∏„Éß„É≥„ÇíÁîüÊàê
            VERSION="v1.0.$(date +'%Y%m%d-%H%M')"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Generated version: ${VERSION}"

      - name: Download CPU artifact
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: BackgroundRemover_Windows_CPU_*

      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: BackgroundRemover_macOS_*

      - name: Find GPU artifact URL
        id: gpu_artifact
        run: |
          # GPUÁâàArtifact„ÅÆ„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâURLÔºàGitHub Actions„Éö„Éº„Ç∏Ôºâ„ÇíÁîüÊàê
          GPU_ARTIFACT_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "url=${GPU_ARTIFACT_URL}" >> $GITHUB_OUTPUT

      - name: List downloaded artifacts
        run: |
          echo "Downloaded artifacts:"
          find artifacts -type d -o -type f | head -50

      - name: Create ZIP archives with timestamp
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Windows CPUÁâà„ÇízipÂåñ
          CPU_DIR=$(find artifacts -type d -name "BackgroundRemover_Windows_CPU_*" | head -1)
          if [ -n "$CPU_DIR" ]; then
            cd "$CPU_DIR"
            zip -r "../../BackgroundRemover_Windows_CPU_${VERSION}.zip" .
            cd ../..
          fi

          # macOSÁâà„ÇízipÂåñ
          MAC_DIR=$(find artifacts -type d -name "BackgroundRemover_macOS_*" | head -1)
          if [ -n "$MAC_DIR" ]; then
            cd "$MAC_DIR"
            zip -r "../../BackgroundRemover_macOS_${VERSION}.zip" .
            cd ../..
          fi

          echo "Created ZIP files:"
          ls -la *.zip

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          files: |
            BackgroundRemover_Windows_CPU_${{ steps.version.outputs.version }}.zip
            BackgroundRemover_macOS_${{ steps.version.outputs.version }}.zip
          body: |
            ## „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ

            ### Ê∑ª‰ªò„Éï„Ç°„Ç§„É´
            - **Windows CPUÁâà** - BackgroundRemover_Windows_CPU_${{ steps.version.outputs.version }}.zip
            - **macOSÁâà** - BackgroundRemover_macOS_${{ steps.version.outputs.version }}.zip

            ### Windows GPUÁâà (CUDAÂØæÂøú)
            GPUÁâà„ÅØ2GB„ÇíË∂Ö„Åà„Çã„Åü„ÇÅ„ÄÅGitHub Artifacts„Åã„Çâ„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:
            üëâ **[Windows GPUÁâà„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ](${{ steps.gpu_artifact.outputs.url }})**

            ‚Äª Artifacts„Éö„Éº„Ç∏„Åß„ÄåBackgroundRemover_Windows_GPU_xxx„Äç„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ

            ---
            _Ëá™ÂãïÁîüÊàê„Åï„Çå„Åü„É™„É™„Éº„Çπ„Åß„Åô_
          draft: false
          prerelease: false
